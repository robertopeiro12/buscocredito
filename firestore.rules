rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // FUNCIONES DE UTILIDAD PARA VALIDACIÓN
    // ========================================
    
    // Verificar si el usuario es propietario del documento
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Verificar tipo de usuario desde custom claims o documento
    function getUserType() {
      return request.auth.token.userType;
    }
    
    function isAdmin() {
      return getUserType() == 'b_admin';
    }
    
    function isLender() {
      return getUserType() == 'b_sale';
    }
    
    function isUser() {
      return getUserType() == 'user';
    }
    
    function isAdminOrLender() {
      return isAdmin() || isLender();
    }
    
    // Verificar si los datos son válidos
    function isValidUserData() {
      return request.resource.data.keys().hasAll(['name', 'email', 'type']) &&
             request.resource.data.email is string &&
             request.resource.data.name is string &&
             request.resource.data.type in ['user', 'b_admin', 'b_sale'];
    }
    
    function isValidSolicitudData() {
      return request.resource.data.keys().hasAll(['userId', 'amount', 'purpose', 'type', 'status']) &&
             request.resource.data.amount is number &&
             request.resource.data.amount > 0 &&
             request.resource.data.userId is string &&
             request.resource.data.status in ['pending', 'approved', 'rejected'];
    }
    
    // ========================================
    // REGLAS PARA CUENTAS DE USUARIO
    // ========================================
    
    match /cuentas/{userId} {
      // Los usuarios solo pueden leer su propia cuenta
      allow read: if isOwner(userId);
      
      // Los usuarios pueden escribir su propia cuenta si los datos son válidos
      allow write: if isOwner(userId) && isValidUserData();
      
      // Admins pueden leer y consultar todas las cuentas (para gestión)
      allow read, list: if isAdmin();
      
      // Lenders pueden leer datos públicos específicos de usuarios con solicitudes
      allow read: if isLender() && 
                     exists(/databases/$(database)/documents/solicitudes/$(userId));
      
      // Admins pueden crear subcuentas (b_sale)
      allow create: if isAdmin() && 
                       request.resource.data.type == 'b_sale' &&
                       request.resource.data.Empresa_id == request.auth.uid;
    }
    
    // ========================================
    // REGLAS PARA SOLICITUDES DE PRÉSTAMO
    // ========================================
    
    match /solicitudes/{solicitudId} {
      // Los usuarios pueden crear sus propias solicitudes
      allow create: if isUser() && 
                       request.resource.data.userId == request.auth.uid &&
                       isValidSolicitudData();
      
      // Los usuarios pueden leer, actualizar y eliminar sus propias solicitudes
      allow read, update, delete: if isUser() && 
                             resource.data.userId == request.auth.uid;
      
      // Lenders pueden leer solicitudes pendientes para hacer ofertas
      allow read: if isLender() && resource.data.status == 'pending';
      
      // Admins pueden leer todas las solicitudes
      allow read: if isAdmin();
      
      // Solo admins pueden cambiar el status (approved/rejected)
      allow update: if isAdmin() && 
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'updatedAt']);
    }
    
    // ========================================
    // REGLAS PARA PROPUESTAS DE PRESTAMISTAS
    // ========================================
    
    match /propuestas/{propuestaId} {
      // Lenders pueden crear propuestas para solicitudes existentes
      allow create: if isLender() && 
                       exists(/databases/$(database)/documents/solicitudes/$(request.resource.data.loanId)) &&
                       request.resource.data.partner == request.auth.uid &&
                       request.resource.data.amount is number &&
                       request.resource.data.amount > 0;
      
      // Lenders pueden leer y actualizar sus propias propuestas
      allow read, update: if isLender() && 
                             resource.data.partner == request.auth.uid;
      
      // Usuarios pueden leer propuestas dirigidas a sus solicitudes
      allow read: if isUser() && 
                     exists(/databases/$(database)/documents/solicitudes/$(resource.data.loanId)) &&
                     get(/databases/$(database)/documents/solicitudes/$(resource.data.loanId)).data.userId == request.auth.uid;
      
      // Usuarios pueden actualizar el status de propuestas (aceptar/rechazar)
      allow update: if isUser() && 
                       exists(/databases/$(database)/documents/solicitudes/$(resource.data.loanId)) &&
                       get(/databases/$(database)/documents/solicitudes/$(resource.data.loanId)).data.userId == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['status', 'updatedAt']);
      
      // Admins pueden leer y consultar todas las propuestas
      allow read, list: if isAdmin();
    }
    
    // ========================================
    // REGLAS PARA NOTIFICACIONES
    // ========================================
    
    match /notifications/{notificationId} {
      // Los usuarios solo pueden leer sus propias notificaciones
      allow read: if request.auth != null && 
                     resource.data.recipientId == request.auth.uid;
      
      // Los usuarios pueden marcar como leídas sus notificaciones
      allow update: if request.auth != null && 
                       resource.data.recipientId == request.auth.uid &&
                       request.resource.data.diff(resource.data).affectedKeys()
                         .hasOnly(['read', 'readAt']);
      
      // Solo el sistema (Admin SDK) puede crear notificaciones
      // Las notificaciones se crean desde Cloud Functions o Admin SDK
      allow create: if false; // Solo Admin SDK puede crear
      
      // Admins pueden leer todas las notificaciones
      allow read: if isAdmin();
    }
    
    // ========================================
    // REGLAS PARA SUBCUENTAS
    // ========================================
    
    match /subcuentas/{subcuentaId} {
      // Solo admins pueden gestionar subcuentas
      allow read, write, create, delete: if isAdmin();
      
      // Las subcuentas pueden leer su propia información
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
    }
    
    // ========================================
    // REGLAS PARA MÉTRICAS Y ANALYTICS
    // ========================================
    
    match /metrics/{document=**} {
      // Solo admins pueden acceder a métricas
      allow read, write: if isAdmin();
    }
    
    // ========================================
    // REGLA POR DEFECTO: DENEGAR TODO
    // ========================================
    
    match /{document=**} {
      allow read, write: if false;
    }
  }
}